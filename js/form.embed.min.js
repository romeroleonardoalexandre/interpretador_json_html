$(document).ready(function(){window.formEl=$(options.name);var o=$("#progress");var f=$("#bar");var m=$("#percent");var p=$("fieldset");var q,a,b;var h=false;var e=0;formEl.attr("role","form");$("<input>").attr({type:"hidden",id:"_csrf",name:"_csrf",value:options._csrf}).appendTo(formEl);if(options.autocomplete){formEl.attr("autocomplete","on")}else{formEl.attr("autocomplete","off")}if(options.novalidate){formEl.attr("novalidate","novalidate")}else{if(formEl.attr("novalidate")!=="novalidate"){formEl.removeAttr("novalidate")}}if(options.resume){formEl.resume({key:"form_app_"+options.id})}setInterval(n,100);var d;function n(){var r=Math.max(window.document.body.scrollHeight,window.document.body.offsetHeight,window.document.documentElement.offsetHeight);if(d!==r){Utils.postMessage({height:r});d=r}}$(window).load(function(){if(options.mode==="preview"){return false}var s=$("canvas");if(s.length>0){for(var r=0;r<s.length;r++){(function(A){var C=new SignaturePad(A),B=C.canvas.id,x="#hidden_"+B,z="#clear_"+B,D="#undo_"+B;var y=function(){var F=C.toData();if(F.length>0){var E={data:C.toData(),dataURL:C.toDataURL()};$(x).val(JSON.stringify(E))}else{$(x).val("")}$(x).trigger("change")};C.onEnd=function(){y()};var w=$("#"+B).data("color");if(w&&w.length>0&&w!=="black"){C.penColor=w}$(z).on("click",function(){C.clear();y()});$(D).on("click",function(){var E=C.toData();if(E){E.pop();C.fromData(E);y()}});formEl.on("success",function(){C.clear();y()})})(s[r])}}var t=Utils.getUrlVars()["parentUrl"];t=t&&t.length>0?decodeURIComponent(t):window.location.href;if(t&&t.length>0){formEl.find(":input").each(function(){var x=$(this);var w=Utils.getUrlVars(t)[x.attr("id")];if(!w&&x.data("alias")&&x.data("alias").length>0){w=Utils.getUrlVars(t)[x.data("alias")]}if(x.attr("type")==="checkbox"||x.attr("type")==="radio"){if(w==="true"||w==="false"){x.prop("checked",(w==="true")).trigger("change")}}else{if(w){w=decodeURIComponent(w);x.val(w).trigger("change")}}})}if(options.defaultValues){options.defaultValues=JSON.parse(options.defaultValues);$.each(options.defaultValues,function(z,x){var w=z.split("_",1).shift();var y=$("#"+z);if(w==="checkbox"||w==="radio"){y.prop("checked",x).trigger("change")}else{y.val(x).trigger("change")}})}if(options.submissionData&&options.fields){var v=JSON.parse(options.submissionData);var u=$.map(options.fields,function(x,w){return x.name});$.each(u,function(A,E){var y=E.split("_",1);var w=y[0];if(w==="selectlist"){var z=v[E];$('select[name="'+E+'[]"] option:selected').prop("selected",false);$('select[name="'+E+'[]"]').each(function(){var F=$(this);if(typeof z==="string"){$('select[name="'+E+'[]"] option[value="'+z+'"]').prop("selected",true)}else{if(Array.isArray(z)){$.each(z,function(G,H){$('select[name="'+E+'[]"] option[value="'+H+'"]').prop("selected",true)})}}})}else{if(w==="checkbox"){var x=v[E];$('input[name="'+E+'[]"]').prop("checked",false).each(function(){var F=$(this);if(typeof x!=="undefined"){$.each(x,function(G,H){if(F.val()===H){F.prop("checked",true)}})}})}else{if(w==="radio"){$('input[name="'+E+'"]').each(function(F,H){var G=$(H);if(G.val()===v[E]){G.prop("checked",true)}})}else{if(w==="matrix"){var C=$("#"+E);if(C.length===0||(C.not("input")&&!C.is("select")&&!C.is("textarea"))){C=$('input[name="'+E+'"]');if(C.length===0){C=$('input[name="'+E+'[]"]')}}if(C.is("select")){var z=v[E];$('select[name="'+E+'[]"] option:selected').prop("selected",false);$('select[name="'+E+'[]"]').each(function(){var F=$(this);if(typeof z==="string"){$('select[name="'+E+'[]"] option[value="'+z+'"]').prop("selected",true)}else{if(Array.isArray(z)){$.each(z,function(G,H){$('select[name="'+E+'[]"] option[value="'+H+'"]').prop("selected",true)})}}})}else{if(C.is(":radio")){C.each(function(F,H){var G=$(H);if(G.val()===v[E]){G.prop("checked",true)}})}else{if(C.is(":checkbox")){var x=v[E];$('input[name="'+E+'[]"]').prop("checked",false).each(function(){var F=$(this);$.each(x,function(G,H){if(F.val()===H){F.prop("checked",true)}})})}else{C.val(v[E])}}}}else{if(E.substring(0,16)==="hidden_signature"){var D=$("canvas");if(D.length>0){for(var B=0;B<D.length;B++){(function(F){var L=new SignaturePad(F);if(typeof v[E]!=="undefined"&&v[E]){var G=JSON.parse(v[E]);L.fromData(G.data)}var J=L.canvas.id;var M="#hidden_"+J;var I="#clear_"+J;var N="#undo_"+J;var H=function(){var O={data:L.toData(),dataURL:L.toDataURL()};$(M).val(JSON.stringify(O))};$(M).val(v[E]);L.onEnd=function(){H()};var K=$("#"+J).data("color");if(K&&K.length>0&&K!=="black"){L.penColor=K}$(I).on("click",function(){L.clear();$(M).val("")});$(N).on("click",function(){var O=L.toData();if(Array.isArray(O)&&O.length){O.pop();L.fromData(O);H()}})})(D[B])}}}else{$("#"+E).val(v[E])}}}}}})}formEl.trigger("view");formEl.find(":input").each(function(){$(this).one("change",function(){if(h===false){if(options.mode==="preview"){return false}e=(new Date()).getTime();formEl.trigger("fill")}h=true})})});window.nextStep=function(v){v.preventDefault();var u=this;var r=false;a=$(v.currentTarget).parents("fieldset").next();q=$(u).parents("fieldset");if(options.skips.length>0){for(var s=0;s<options.skips.length;s++){if(p.index(q)<options.skips[s].to){var t=p.eq(options.skips[s].to);if(p.index(q)<p.index(t)){if(options.skips[s].from==null||options.skips[s].from==p.index(q)){options.skips[s].from=p.index(q);a=t}break}}}}if(a.is("fieldset")){$.ajax({url:options.validationUrl,type:"post",data:formEl.serialize(),headers:{"X-Requested-With":"XMLHttpRequest",Accept:"application/json"},complete:function(w,x){},beforeSend:function(x,w){var y=q.find("input:file[required]");if(y.size()>0){$.each(y,function(){if($(this).val()){w.data=w.data+"&"+$(this).attr("name")+"=1"}})}w.data=w.data+"&current_page="+p.index(q)},success:function(E){if(E!==null&&typeof E==="object"){q.find(".error-block").remove();q.find(".form-group").removeClass("has-error");$.each(E,function(H,G){var I=q.find("#"+H).parent(".form-group");if(I.size()>0){r=true;I.addClass("has-error");var F=$("<div>",{"class":"help-block error-block",html:G});I.append(F)}})}if(!r){q.hide();var B=$(".steps");if(B.size()>0){B.find(".step").eq(p.index(q)).removeClass("current");B.find(".step").eq(p.index(a)).prevAll().addClass("success");B.find(".step").eq(p.index(a)).addClass("current")}else{var w=$(".progress").first();var z=w.find(".progress-bar");var A=z.find(".percent");var C=z.find(".title");var y=z.data("titles");if(typeof y!=="undefined"){y=y.split(",");var x=y[p.index(a)];C.html(x)}var D=Math.round(100/p.size()*p.index(a))+"%";A.text(D);z.width(D)}if(a.is("fieldset")){a.show();b=q}}formEl.trigger("nextStep");Utils.postMessage({scrollToTop:"container"})},error:function(){Utils.showMessage("#messages",options.i18n.unexpectedError,"danger");formEl.hide();Utils.postMessage({scrollToTop:"container"})}})}};window.previousStep=function(w){w.preventDefault();if(b.is("fieldset")){q=$(this).parents("fieldset");for(var t=0;t<options.skips.length;t++){if(p.index(q)==options.skips[t].to){b=p.eq(options.skips[t].from);break}}var y=$(".steps");if(y.size()>0){y.find(".step").removeClass("success");y.find(".step").eq(p.index(q)).removeClass("current");y.find(".step").eq(p.index(b)).prevAll().addClass("success");y.find(".step").eq(p.index(b)).addClass("current")}else{var r=$(".progress").first();var v=r.find(".progress-bar");var x=v.find(".percent");var z=v.find(".title");var u=v.data("titles");if(typeof u!=="undefined"){u=u.split(",");var s=u[p.index(b)];z.html(s)}var A=Math.round(100/p.size()*p.index(b))+"%";x.text(A);v.width(A)}q.hide();b.show();b=b.prev();formEl.trigger("previousStep");Utils.postMessage({scrollToTop:"container"})}};$("input").on("keypress",function(s){if(s.keyCode==13){var r=$(s.currentTarget).parents("fieldset").find(".next");if(r.size()>0){s.preventDefault();r.click();return false}}});$(".next").click(nextStep);$(".previous").click(previousStep);formEl.ajaxForm({url:options.actionUrl,type:"post",dataType:"json",beforeSubmit:function(v,t,u){if(options.mode==="preview"){return false}var s=false;$.each(t.find('input[type="file"]'),function(w,x){if($(x).val()){s=true}});if(s){o.show();var r="0%";f.css("width",r);m.html(r+" "+options.i18n.complete)}formEl.find(":submit").attr("disabled",true);formEl.trigger("beforeSubmit")},uploadProgress:function(v,r,u,t){var s=t+"%";f.css("width",s);m.html(s+" "+options.i18n.complete)},success:function(r){if(r.success){g();l(r)}else{j(r)}},error:function(r,t,s){Utils.showMessage("#messages",options.i18n.unexpectedError,"danger");formEl.hide();Utils.postMessage({scrollToTop:"container"})}});function c(){$(".error-block").remove();$(".form-group").removeClass("has-error")}function g(){c();formEl.find(":submit").attr("disabled",false);if(!(options.submissionData&&options.fields)){formEl.resetForm()}o.hide()}function l(H){options.submitted=true;var v=(new Date()).getTime();var r=v-e;formEl.trigger("success",[H,r]);if(p.size()>1){var D=$(".steps");if(D.size()>0){D.find(".step").addClass("success")}else{var x=$(".progress").first();var B=x.find(".progress-bar");var t=B.find(".percent");var I=B.find(".title");I.html("Complete");t.text("100%");B.width("100%")}}if(typeof H.addon!=="undefined"){if(typeof H.addon.redirectTo!=="undefined"){var w=H.addon.redirectTo;if(window.location!==window.parent.location){Utils.postMessage({url:w})}else{window.location.href=w?w:"/"}}}var C=typeof H.confirmationType==="undefined"?options.confirmationType:H.confirmationType;var E=typeof H.message==="undefined"?options.confirmationMessage:H.message;var s=typeof H.confirmationUrl==="undefined"?options.confirmationUrl:H.confirmationUrl;var y=typeof H.confirmationSeconds==="undefined"?options.confirmationSeconds:H.confirmationSeconds;var G=typeof H.redirectToUrl==="undefined"?options.redirectToUrl:H.redirectToUrl;var u=typeof H.showOnlyMessage==="undefined"?options.showOnlyMessage:H.showOnlyMessage;var F=function(){if(window.location!==window.parent.location){Utils.postMessage({url:s})}else{window.location.href=s?s:"/"}};var z=function(){Utils.hideMessage("#messages");Utils.showMessage("#messages",E,"success");if(C===u){formEl.hide()}Utils.postMessage({scrollToTop:"container"})};if(C===G){var A=parseInt(y,10);if(A>0){z();setTimeout(function(){F()},A*1000)}else{F()}}else{z()}}function j(s){Utils.hideMessage("#messages");if(typeof s.message!=="undefined"){Utils.showMessage("#messages",s.message,"danger")}Utils.postMessage({scrollToTop:"container"});c();if(typeof s.errors!=="undefined"&&s.errors.length>0){var u=s.errors;for(k=0;k<u.length;k++){var t=$("#"+u[k].field).closest(".form-group");t.addClass("has-error");for(i=0;i<u[k].messages.length;i++){var r=$("<div>",{"class":"help-block error-block",html:u[k].messages[i]});t.append(r)}}}formEl.find(":submit").removeAttr("disabled");formEl.trigger("error",s)}formEl.on("view",function(r){Utils.postMessage({action:"view"})});formEl.on("fill",function(r){Utils.postMessage({action:"fill"})});formEl.on("nextStep",function(r){Utils.postMessage({action:"nextStep"})});formEl.on("previousStep",function(r){Utils.postMessage({action:"previousStep"})});formEl.on("beforeSubmit",function(){Utils.postMessage({action:"beforeSubmit"})});formEl.on("error",function(r,s){Utils.postMessage({action:"error",data:s})});formEl.on("success",function(r,t,s){Utils.postMessage({action:"success",data:t,completionTime:s})});if(options.analytics){(function(v,s,x,r,t,y,u){if(!v[t]){v.FA=v.FA||[];v.FA.push(t);v[t]=function(){(v[t].q=v[t].q||[]).push(arguments)};v[t].q=v[t].q||[];y=s.createElement(x);u=s.getElementsByTagName(x)[0];y.async=1;y.src=r;u.parentNode.insertBefore(y,u)}}(window,document,"script",options.tracker,"tracker"));window.tracker("newTracker","t"+options.id,options.app,{encodeBase64:false,appId:options.id});formEl.on("view",function(r){window.tracker("setCustomUrl",decodeURIComponent(Utils.getUrlVars()["url"]));window.tracker("setReferrerUrl",decodeURIComponent(Utils.getUrlVars()["referrer"]));window.tracker("trackPageView",decodeURIComponent(Utils.getUrlVars()["title"]))});formEl.on("fill",function(r){window.tracker("trackStructEvent","form","fill","start",null,null)});formEl.on("error",function(r){window.tracker("trackStructEvent","form","error",null,null,null)});formEl.on("success",function(r,t,s){window.tracker("trackStructEvent","form","submit",t.id,"time",s)})}});